<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ROUTINE TIMER</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: var(--bs-body-bg);
    }

    .routine-card {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .routine-card:hover {
      transform: scale(1.03);
    }

    #timerView {
      display: none;
    }

    .timer-number {
      font-size: 4rem;
      font-weight: bold;
    }

    .task-current {
      background-color: #d1e7dd;
      font-weight: 600;
    }

    .task-complete {
      opacity: 0.5;
      text-decoration: line-through;
    }

    #scheduleTableBody tr {
      transition: background-color 0.4s ease, opacity 0.4s ease;
    }
  </style>
</head>

<body>

<div class="container py-4">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 
        class="mb-0"
        style="cursor: pointer"
        onclick="resetToHome()">
        Routine Timer
    </h2>
    <button class="btn btn-outline-secondary" onclick="toggleTheme()">üåô</button>
  </div>

  <!-- ROUTINE GRID -->
  <div id="routineGrid">
    <div class="row g-4">

      <div class="col-md-6">
        <div class="card routine-card" onclick="startRoutine('morning')">
          <img src="https://via.placeholder.com/600x300?text=Morning+Routine" class="card-img-top">
          <div class="card-body text-center">
            <h5 class="card-title">Morning Routine</h5>
            <p class="text-muted small" id="morningMeta"></p>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card routine-card" onclick="startRoutine('night')">
          <img src="https://via.placeholder.com/600x300?text=Night+Routine" class="card-img-top">
          <div class="card-body text-center">
            <h5 class="card-title">Night Routine</h5>
            <p class="text-muted small" id="nightMeta"></p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- TIMER VIEW -->
  <div id="timerView" class="text-center">

    <h3 id="routineTitle"></h3>
    <h5 id="taskName" class="mb-3"></h5>

    <div class="timer-number mb-3" id="timeLeft">00:00</div>

    <div class="mb-3">
        <button class="btn btn-warning me-2" onclick="pauseTimer()">Pause</button>
        <button class="btn btn-success me-2" onclick="resumeTimer()">Resume</button>
        <button class="btn btn-outline-primary" onclick="skipTask()">Next Task ‚è≠Ô∏è</button>
    </div>


    <p class="text-muted">
      Task <span id="taskIndex"></span> of <span id="taskTotal"></span>
    </p>

    <!-- MOBILE COLLAPSIBLE SCHEDULE -->
    <button class="btn btn-outline-secondary w-100 d-md-none mb-3"
      data-bs-toggle="collapse"
      data-bs-target="#scheduleCollapse">
      Toggle Schedule
    </button>

    <div class="collapse d-md-block" id="scheduleCollapse">
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Task</th>
            <th>Duration</th>
            <th>Done By</th>
          </tr>
        </thead>
        <tbody id="scheduleTableBody"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- SOUNDS -->
<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="done" src="https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= DATA ================= */

const routines = {
  morning: {
    title: "Morning Routine",
    tasks: [
      { name: "Get Up", minutes: 15 },
      { name: "Stretch", minutes: 5 },
      { name: "Shower", minutes: 15 },
      { name: "Breakfast", minutes: 20 }
    ]
  },
  night: {
    title: "Night Routine",
    tasks: [
      { name: "Wind Down", minutes: 10 },
      { name: "Skincare", minutes: 10 },
      { name: "Read", minutes: 20 }
    ]
  }
};

let currentRoutineKey = null;
let currentRoutine = null;
let currentTaskIndex = 0;
let timeRemaining = 0;
let timerInterval = null;
let paused = false;
let lastBeepSecond = null;


/* ================= HELPERS ================= */

function formatTime(date) {
  return date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
}

function getTotalMinutes(tasks) {
  return tasks.reduce((s, t) => s + t.minutes, 0);
}

/* ================= ROUTINE META ================= */

function populateRoutineMeta() {
  Object.keys(routines).forEach(key => {
    const r = routines[key];
    const total = getTotalMinutes(r.tasks);
    const done = new Date(Date.now() + total * 60000);
    document.getElementById(`${key}Meta`).innerText =
      `${r.tasks.length} tasks ‚Ä¢ ${total} min ‚Ä¢ Done by ${formatTime(done)}`;
  });
}

/* ================= SCHEDULE ================= */

function buildScheduleTable(startTime = new Date()) {
  const tbody = document.getElementById("scheduleTableBody");
  tbody.innerHTML = "";

  let t = new Date(startTime);

  currentRoutine.tasks.forEach((task, i) => {
    t = new Date(t.getTime() + task.minutes * 60000);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${task.name}</td>
      <td>${task.minutes} min</td>
      <td>${formatTime(t)}</td>
    `;
    tbody.appendChild(row);
  });
}

function updateScheduleHighlight() {
  document.querySelectorAll("#scheduleTableBody tr").forEach((row, i) => {
    row.classList.remove("task-current", "task-complete");
    if (i < currentTaskIndex) row.classList.add("task-complete");
    if (i === currentTaskIndex) row.classList.add("task-current");
  });
}

/* ================= TIMER ================= */

function startRoutine(key, resume = false) {
  currentRoutineKey = key;
  currentRoutine = routines[key];

  document.getElementById("routineGrid").style.display = "none";
  document.getElementById("timerView").style.display = "block";
  document.getElementById("routineTitle").innerText = currentRoutine.title;
  document.getElementById("taskTotal").innerText = currentRoutine.tasks.length;

  buildScheduleTable();
  if (!resume) currentTaskIndex = 0;
  startTask();
}

function startTask() {
  const task = currentRoutine.tasks[currentTaskIndex];
  if (!paused) timeRemaining ||= task.minutes * 60;

  lastBeepSecond = null;

  document.getElementById("taskName").innerText = task.name;
  document.getElementById("taskIndex").innerText = currentTaskIndex + 1;

  updateScheduleHighlight();
  updateTimerDisplay();

  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (!paused) {
        timeRemaining--;

        // üîî 5-second countdown beeps
        if (
        timeRemaining <= 5 &&
        timeRemaining > 0 &&
        lastBeepSecond !== timeRemaining
        ) {
        document.getElementById("beep").play();
        lastBeepSecond = timeRemaining;
        }

        saveState();

        if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        currentTaskIndex++;
        timeRemaining = 0;

        document.getElementById("beep").play();

        currentTaskIndex >= currentRoutine.tasks.length
            ? finishRoutine()
            : startTask();
        }

        updateTimerDisplay();
    }
  }, 1000);
}

function updateTimerDisplay() {
  document.getElementById("timeLeft").innerText =
    `${String(Math.floor(timeRemaining / 60)).padStart(2, "0")}:${String(timeRemaining % 60).padStart(2, "0")}`;
}

function pauseTimer() { paused = true; }
function resumeTimer() {
  paused = false;
  refreshScheduleFromNow();
}


/* ================= COMPLETE ================= */

function finishRoutine() {
  document.getElementById("done").play();
  localStorage.removeItem("routineState");
  document.getElementById("taskName").innerText = "Routine Complete üéâ";
}

/* ================= STORAGE ================= */

function saveState() {
  localStorage.setItem("routineState", JSON.stringify({
    key: currentRoutineKey,
    task: currentTaskIndex,
    time: timeRemaining
  }));
}

function loadState() {
  const state = JSON.parse(localStorage.getItem("routineState"));
  if (state) {
    currentTaskIndex = state.task;
    timeRemaining = state.time;
    startRoutine(state.key, true);
  }
}

/* ================= SKIP TASK ================= */

function skipTask() {
  clearInterval(timerInterval);
  document.getElementById("beep").play();

  currentTaskIndex++;
  timeRemaining = 0;
  paused = false;

  if (currentTaskIndex >= currentRoutine.tasks.length) {
    finishRoutine();
    return;
  }

  refreshScheduleFromNow();
  startTask();
}

function refreshScheduleFromNow() {
  const tbody = document.getElementById("scheduleTableBody");
  tbody.innerHTML = "";

  let now = new Date();

  currentRoutine.tasks.forEach((task, index) => {
    const row = document.createElement("tr");

    if (index < currentTaskIndex) {
      row.classList.add("task-complete");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${task.name}</td>
        <td>${task.minutes} min</td>
        <td>‚úî</td>
      `;
    } else {
      now = new Date(now.getTime() + task.minutes * 60000);
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${task.name}</td>
        <td>${task.minutes} min</td>
        <td>${formatTime(now)}</td>
      `;
    }

    tbody.appendChild(row);
  });

  updateScheduleHighlight();
}

/* ================= RESET LOGO ================= */

function resetToHome() {
  if (currentRoutine) {
    const confirmReset = confirm("End current routine and return home?");
    if (!confirmReset) return;
  }

  clearInterval(timerInterval);
  timerInterval = null;

  currentRoutineKey = null;
  currentRoutine = null;
  currentTaskIndex = 0;
  timeRemaining = 0;
  paused = false;

  localStorage.removeItem("routineState");

  document.getElementById("timerView").style.display = "none";
  document.getElementById("routineGrid").style.display = "block";

  populateRoutineMeta();
}





/* ================= THEME ================= */

function toggleTheme() {
  const html = document.documentElement;
  const next = html.dataset.bsTheme === "light" ? "dark" : "light";
  html.dataset.bsTheme = next;
  localStorage.setItem("theme", next);
}

function loadTheme() {
  document.documentElement.dataset.bsTheme =
    localStorage.getItem("theme") || "light";
}

/* ================= INIT ================= */

loadTheme();
populateRoutineMeta();
loadState();

</script>

</body>
</html>
